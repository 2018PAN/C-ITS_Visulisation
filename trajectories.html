<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vehicle Trajectories Visualization</title>
    <!-- deck.gl & MapLibre -->
    <script src="https://unpkg.com/deck.gl@8.9.30/dist.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.2.1/dist/maplibre-gl.css" />
    <script src="https://unpkg.com/maplibre-gl@3.2.1/dist/maplibre-gl.js"></script>
    <!-- noUiSlider -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: sans-serif;
            background: #000;
            color: #fff;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #controls {
            position: absolute;
            top: 10px;
            left: 15px;
            z-index: 200;
            background: rgba(0, 0, 0, 0.7);
            padding: 16px 36px;
            padding-bottom: 40px;
            border-radius: 8px;
            width: 320px;
            overflow: hidden;
        }

        #controls select {
            width: 100%;
            padding: 10px 8px;
            font-size: 17px;
            border-radius: 4px;
            border: 1px solid #555;
            background: #111;
            color: #fff;
            box-sizing: border-box;
        }

        #stationType {
            width: 100%;
            padding: 8px;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #555;
            background: #111;
            color: #fff;
            margin-top: 6px;
            margin-bottom: 12px;
        }

        #time-range-labels {
            text-align: center;
            margin-bottom: 12px;
            font-size: 17px;
        }

        #slider {
            margin: 12px 0;
        }

        .noUi-connect {
            background: #26a69a;
        }

        .noUi-horizontal .noUi-handle {
            background: #fff;
            width: 25px;
            border: 1px solid #888;
        }

        #popup {
            position: absolute;
            z-index: 201;
            background: rgba(135, 135, 135, 0.9);
            color: #fff;
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 14px;
            pointer-events: none;
            white-space: nowrap;
            display: none;
        }

        #viewTabs {
            display: flex;
            margin-bottom: 12px;
        }

        #viewTabs button {
            flex: 1;
            padding: 8px;
            background: #222;
            color: #ccc;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 8px;
        }

        #viewTabs button.active {
            background: #26a69a;
            color: #000;
            font-weight: bold;
        }

        #viewTabs button+button {
            margin-left: 4px;
        }
    </style>
</head>

<body>

    <div id="controls">
        <div id="viewTabs">
            <button id="tabRoad">Road View</button>
            <button id="tabTraj" class="active">Trajectory View</button>
            <button id="tabDenm">DENM View</button>
        </div>
        <label for="stationType">Station Type:</label>
        <select id="stationType">
            <option value="all">All</option>
            <option value="5">Passenger Car</option>
            <option value="6">Bus</option>
            <option value="7">Light Truck</option>
            <option value="10">Special Vehicles</option>
        </select>

        <div id="time-range-labels">
            <label>Time Range(2025-04-07)</label><br />
            <span id="min-time">--:--:--</span> &mdash; <span id="max-time">--:--:--</span>
        </div>
        <div id="slider"></div>

    </div>

    <div id="map"></div>
    <div id="popup"></div>

    <script>
        const INITIAL_VIEW_STATE = { latitude: 47.7, longitude: 13.05, zoom: 10, pitch: 0, bearing: 0 };

        function formatTime(ms) {
            return new Date(ms).toTimeString().slice(0, 8);
        }

        function getSpeedColor(s) {
            if (s < 2) return [255, 0, 0];
            if (s < 6) return [255, 165, 0];
            if (s < 12) return [255, 255, 0];
            return [0, 255, 0];
        }

        async function loadAll() {
            const files = [
                'Data/cams_04_07_7-8/cams_04_07_7-8_1_filtered.json',
                'Data/cams_04_07_7-8/cams_04_07_7-8_2_filtered.json',
                'Data/cams_04_07_7-8/cams_04_07_7-8_3_filtered.json'
            ];
            const arrs = await Promise.all(files.map(p => fetch(p).then(r => r.json())));
            return arrs.flat();
        }

        function groupSegments(data, st, [t0, t1]) {
            const byId = {};
            data.forEach(p => {
                if ((st !== 'all' && p.stationType != st) || p.timestamp < t0 || p.timestamp > t1) return;
                (byId[p.stationID] || (byId[p.stationID] = [])).push(p);
            });
            const segs = [], maxDist = 500, maxDt = 10000;
            for (const id in byId) {
                const pts = byId[id].sort((a, b) => a.timestamp - b.timestamp);
                let seg = [pts[0]];
                for (let i = 1; i < pts.length; i++) {
                    const a = pts[i - 1], b = pts[i];
                    const toRad = d => d * Math.PI / 180;
                    const dLat = toRad(b.latitude - a.latitude),
                        dLon = toRad(b.longitude - a.longitude);
                    const A = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(a.latitude)) * Math.cos(toRad(b.latitude)) * Math.sin(dLon / 2) ** 2;
                    const dist = 6371000 * 2 * Math.atan2(Math.sqrt(A), Math.sqrt(1 - A)),
                        dt = b.timestamp - a.timestamp;
                    if (dist <= maxDist && dt <= maxDt) seg.push(b);
                    else {
                        if (seg.length > 1) segs.push(seg);
                        seg = [b];
                    }
                }
                if (seg.length > 1) segs.push(seg);
            }
            return segs.map(seg => ({
                coordinates: seg.map(p => [p.longitude, p.latitude]),
                speed: seg.reduce((s, p) => s + p.speed_m_s, 0) / seg.length,
                stationID: seg[0].stationID,
                stationType: seg[0].stationType,
                timestamp: seg[0].timestamp
            }));
        }

        let rawData, deckgl, slider, timeRange;

        async function main() {
            initTabs();
            rawData = await loadAll();
            const times = rawData.map(p => p.timestamp),
                tmin = Math.min(...times), tmax = Math.max(...times);
            timeRange = [tmin, tmax];

            slider = noUiSlider.create(document.getElementById('slider'), {
                start: [tmin, tmax],
                connect: true,
                range: { min: tmin, max: tmax },
                step: 1000,
                tooltips: false,
                pips: {
                    mode: 'count',
                    values: 3,
                    format: {
                        to: v => {
                            const d = new Date(+v);
                            const hh = String(d.getHours()).padStart(2, '0');
                            const mm = String(d.getMinutes()).padStart(2, '0');
                            return `${hh}:${mm}`;
                        },
                        from: v => Number(v)
                    }
                }
            });

            document.getElementById('min-time').textContent = formatTime(tmin);
            document.getElementById('max-time').textContent = formatTime(tmax);

            slider.on('update', vals => {
                timeRange = vals.map(v => +v);
                document.getElementById('min-time').textContent = formatTime(timeRange[0]);
                document.getElementById('max-time').textContent = formatTime(timeRange[1]);
            });
            slider.on('change', render);

            deckgl = new deck.DeckGL({
                container: 'map',
                mapLib: maplibregl,
                mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
                initialViewState: INITIAL_VIEW_STATE,
                controller: true,
                getCursor: ({ isHovering }) => isHovering ? 'pointer' : 'grab'
            });

            document.getElementById('stationType').addEventListener('change', render);
            render();
        }

        function render() {
            const st = document.getElementById('stationType').value;
            const segs = groupSegments(rawData, st, timeRange);
            const popup = document.getElementById('popup');

            const STATION_TYPE_NAMES = {
                5: 'Passenger Car',
                6: 'Bus',
                7: 'Light Truck',
                10: 'Special Vehicles'
            };

            const layer = new deck.PathLayer({
                id: 'paths',
                data: segs,
                pickable: true,
                getPath: d => d.coordinates,
                getColor: d => getSpeedColor(d.speed),
                getWidth: 2,
                widthMinPixels: 2,
                onHover: ({ object, x, y }) => {
                    if (object) {
                        const name = STATION_TYPE_NAMES[object.stationType] || 'Unknown';
                        popup.style.display = 'block';
                        popup.style.left = `${x + 10}px`;
                        popup.style.top = `${y + 10}px`;
                        popup.innerHTML =
                            `<strong>StationID:</strong> ${object.stationID}<br/>` +
                            `<strong>StationType:</strong> ${name}<br/>` +
                            `<strong>Start Time:</strong> ${formatTime(object.timestamp)}<br/>` +
                            `<strong>Avg Speed:</strong> ${object.speed.toFixed(2)} m/s`;
                    } else {
                        popup.style.display = 'none';
                    }
                }
            });

            deckgl.setProps({ layers: [layer] });
        }

        function initTabs() {
            const tabRoad = document.getElementById('tabRoad');
            const tabTraj = document.getElementById('tabTraj');
            const tabDenm = document.getElementById('tabDenm');

            tabRoad.addEventListener('click', () => {
                tabRoad.classList.add('active');
                tabTraj.classList.remove('active');
                window.location.href = 'index.html';
            });

            tabTraj.addEventListener('click', () => {
                tabTraj.classList.add('active');
                tabDenm.classList.remove('active');
                tabRoad.classList.remove('active');
                window.location.href = 'trajectories.html';
            });

            tabDenm.addEventListener('click', () => {
                tabDenm.classList.add('active');
                tabRoad.classList.remove('active');
                tabTraj.classList.remove('active');
                window.location.href = 'denms.html';
            });
        }

        main();
    </script>
</body>

</html>