<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DENM Events Visualization</title>

  <!-- deck.gl & MapLibre GL -->
  <script src="https://unpkg.com/deck.gl@8.9.30/dist.min.js"></script>
  <link href="https://unpkg.com/maplibre-gl@3.2.1/dist/maplibre-gl.css" rel="stylesheet"/>
  <script src="https://unpkg.com/maplibre-gl@3.2.1/dist/maplibre-gl.js"></script>

  <!-- noUiSlider -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>

  <style>
    body { margin:0; background:#000; color:#fff; font-family:sans-serif; }
    #map { position:absolute; top:0; bottom:0; width:100%; }

    /* 左上控件 */
    #controls {
      position:absolute; top:10px; left:15px; z-index:200;
      background:rgba(0,0,0,0.7); padding:16px 36px;
      padding-bottom:40px; border-radius:8px; width:320px;
      overflow:hidden;
    }
    #viewTabs { display:flex; margin-bottom:12px; }
    #viewTabs button {
      flex:1; padding:8px; background:#222; color:#ccc; border:none;
      cursor:pointer; font-size:16px; border-radius:8px;
    }
    #viewTabs button.active {
      background:#26a69a; color:#000; font-weight:bold;
    }
    #viewTabs button+button { margin-left:4px; }
    #controls label {
      display:inline-block; margin-right:12px; cursor:pointer;
    }
    #time-range-labels {
      text-align:center; margin-top:20px; margin-bottom:12px;
      font-size:17px;
    }
    #slider { margin:12px 0; }
    .noUi-connect { background:#26a69a; }
    .noUi-horizontal .noUi-handle {
      background:#fff; width:25px; border:1px solid #888;
    }

    /* 图例 */
    #legend {
      position:absolute; bottom:20px; right:20px;
      background:rgba(0,0,0,0.8); color:#fff;
      padding:16px 20px; border-radius:10px;
      box-shadow:0 4px 12px rgba(0,0,0,0.6);
      pointer-events:none;
    }
    #legend h4 {
      margin:0 0 12px; font-size:18px; font-weight:600;
      letter-spacing:0.5px;
    }
    #legend ul { list-style:none; margin:0; padding:0; }
    #legend li {
      display:flex; align-items:center; margin-bottom:10px;
      font-size:15px; line-height:1.4;
    }
    .legend-dot {
      width:14px; height:14px; border-radius:50%;
      margin-right:10px; border:1px solid rgba(255,255,255,0.3);
    }

    /* 弹窗 */
    #popup {
      position:absolute; z-index:300;
      pointer-events:none; display:none;
      white-space:normal; max-width:240px;
    }
    .popup-card {
      background:rgba(30,30,30,0.95); border-radius:6px;
      overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.7);
    }
    .popup-header {
      padding:8px 12px; font-size:16px; font-weight:600;
      color:#000;
    }
    .popup-body {
      padding:10px 12px; background:#202020;
      font-size:13px; color:#fff;
    }
    .popup-body .item { margin-bottom:8px; }
  </style>
</head>
<body>
  <div id="controls">
    <div id="viewTabs">
      <button id="tabRoad">Road View</button>
      <button id="tabTraj">Trajectory View</button>
      <button id="tabDenm" class="active">DENM View</button>
    </div>
    <label><input type="checkbox" id="showEvents" checked> Show Events</label>
    <label><input type="checkbox" id="showTraces" checked> Show Traces</label>
    <div id="time-range-labels">
      <label>Time Range (2025-04-07)</label><br/>
      <span id="min-time">--:--:--</span> &mdash; <span id="max-time">--:--:--</span>
    </div>
    <div id="slider"></div>
  </div>

  <div id="map"></div>

  <div id="legend">
    <h4>Event Cause</h4>
    <ul>
      <li>
        <span class="legend-dot" style="background:#ff0000"></span>
        Accident (1)
      </li>
      <li>
        <span class="legend-dot" style="background:#ffff00"></span>
        Obstacle (3)
      </li>
      <li>
        <span class="legend-dot" style="background:#00ff00"></span>
        Other (95)
      </li>
    </ul>
  </div>

  <div id="popup"></div>

  <script>
    const INITIAL_VIEW_STATE = {
      latitude:47.7, longitude:13.05, zoom:10, pitch:0, bearing:0
    };
    function hhmmss(ms){
      const d=new Date(ms);
      return [d.getHours(),d.getMinutes(),d.getSeconds()]
        .map(n=>String(n).padStart(2,'0')).join(':');
    }

    // 文本映射
    const CAUSE_TEXT = {
      1:'Accident',
      3:'Obstacle',
      95:'Other'
    };
    const SUBCAUSE_TEXT = {
      '1-0':'Minor collision',
      '3-1':'Road obstruction',
      '95-1':'Roadworks',
      '95-2':'Weather'
    };
    const CAUSE_COLOR = {
      1:[255,0,0], 3:[255,255,0], default:[0,255,0]
    };

    async function loadDenms(){
      const paths=[
        'Data/denms_04_07-8/denms_04_07-8_1.json',
        'Data/denms_04_07-8/denms_04_07-8_2.json',
        'Data/denms_04_07-8/denms_04_07-8_3.json'
      ];
      const arrs=await Promise.all(paths.map(p=>fetch(p).then(r=>r.json())));
      return arrs.flat();
    }
    function processDenms(raw){
      const DAY0=new Date("2025-04-07T00:00:00+02:00").getTime();
      const DAY1=new Date("2025-04-08T00:00:00+02:00").getTime();
      return raw.filter(item=>
        item.msg&&item.msg.denm&&item.timestamp>=DAY0&&item.timestamp<DAY1
      ).map(item=>{
        const denm=item.msg.denm, mg=denm.management;
        const lat0=mg.eventPosition.latitude/1e7;
        const lon0=mg.eventPosition.longitude/1e7;
        let lat=lat0, lon=lon0;
        const coords=(denm.location.traces[0]||[]).map(step=>{
          lat+=step.pathPosition.deltaLatitude/1e7;
          lon+=step.pathPosition.deltaLongitude/1e7;
          return [lon,lat];
        });
        return {
          base:[lon0,lat0],
          coordinates:coords,
          stationID:mg.actionID.originatingStationID,
          cause:denm.situation.eventType.causeCode,
          subCause:denm.situation.eventType.subCauseCode,
          timestamp:item.timestamp
        };
      });
    }

    let denmData, deckgl, slider, timeRange;
    async function main(){
      initTabs();
      const raw=await loadDenms();
      denmData=processDenms(raw);

      // 计算时间范围
      const ts=denmData.map(d=>d.timestamp);
      const tmin=Math.min(...ts), tmax=Math.max(...ts);
      timeRange=[tmin,tmax];

      // slider
      slider=noUiSlider.create(document.getElementById('slider'),{
        start:[tmin,tmax], connect:true,
        range:{min:tmin,max:tmax}, step:1000,
        tooltips:false,
        pips:{
          mode:'count', values:3,
          format:{ to:v=>hhmmss(+v), from:v=>+v }
        }
      });
      document.getElementById('min-time').textContent=hhmmss(tmin);
      document.getElementById('max-time').textContent=hhmmss(tmax);
      slider.on('update',vals=>{
        timeRange=vals.map(v=>+v);
        document.getElementById('min-time').textContent=hhmmss(timeRange[0]);
        document.getElementById('max-time').textContent=hhmmss(timeRange[1]);
      });
      slider.on('change', render);

      // DeckGL
      deckgl=new deck.DeckGL({
        container:'map',
        mapLib:maplibregl,
        mapStyle:'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
        initialViewState:INITIAL_VIEW_STATE,
        controller:true,
        getCursor:({isHovering})=>isHovering?'pointer':'grab'
      });

      document.getElementById('showEvents').addEventListener('change', render);
      document.getElementById('showTraces').addEventListener('change', render);

      render();
    }

    function render(){
      const showEvents=document.getElementById('showEvents').checked;
      const showTraces=document.getElementById('showTraces').checked;
      const popupEl=document.getElementById('popup');
      const data=denmData.filter(d=>d.timestamp>=timeRange[0]&&d.timestamp<=timeRange[1]);
      const layers=[];

      if(showTraces){
        layers.push(new deck.PathLayer({
          id:'denm-traces', data,
          getPath:d=>d.coordinates,
          getColor:[255,100,100],
          getWidth:4, widthMinPixels:2
        }));
      }

      if(showEvents){
        layers.push(new deck.ScatterplotLayer({
          id:'denm-points', data,
          pickable:true,
          getPosition:d=>d.base,
          getFillColor:d=>CAUSE_COLOR[d.cause]||CAUSE_COLOR.default,
          getRadius:20, radiusMinPixels:6,
          onHover:({object, x, y})=>{
            if(!object){
              popupEl.style.display='none';
              return;
            }
            const c=object.cause, sc=object.subCause;
            const causeText=CAUSE_TEXT[c]||'Unknown';
            const subText=SUBCAUSE_TEXT[`${c}-${sc}`]||'Unknown';
            const color=CAUSE_COLOR[c]||CAUSE_COLOR.default;
            const bg=`rgb(${color.join(',')})`;
            const dt=new Date(object.timestamp)
                        .toISOString().slice(0,19).replace('T',' ');
            popupEl.innerHTML=`
              <div class="popup-card">
                <div class="popup-header" style="background:${bg};">
                  ${causeText} – ${subText}
                </div>
                <div class="popup-body">
                  <div class="item"><strong>Station ID:</strong> ${object.stationID}</div>
                  <div class="item"><strong>Time:</strong> ${dt}</div>
                </div>
              </div>`;
            popupEl.style.left=`${x+10}px`;
            popupEl.style.top=`${y+10}px`;
            popupEl.style.display='block';
          }
        }));
      }

      deckgl.setProps({ layers });
    }

    function initTabs(){
      document.getElementById('tabRoad').onclick=()=>location.href='index.html';
      document.getElementById('tabTraj').onclick=()=>location.href='trajectories.html';
      document.getElementById('tabDenm').classList.add('active');
    }

    main();
  </script>
</body>
</html>
